<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>World age issue · FileIO</title><meta name="title" content="World age issue · FileIO"/><meta property="og:title" content="World age issue · FileIO"/><meta property="twitter:title" content="World age issue · FileIO"/><meta name="description" content="Documentation for FileIO."/><meta property="og:description" content="Documentation for FileIO."/><meta property="twitter:description" content="Documentation for FileIO."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">FileIO</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../registry/">Registry table</a></li><li><a class="tocitem" href="../registering/">Registering a new format</a></li><li><a class="tocitem" href="../implementing/">Implementing loaders/savers</a></li><li class="is-active"><a class="tocitem" href>World age issue</a><ul class="internal"><li><a class="tocitem" href="#Motivation:-lazy-loading"><span>Motivation: lazy loading</span></a></li><li><a class="tocitem" href="#The-hidden-issue"><span>The hidden issue</span></a></li><li><a class="tocitem" href="#Solutions"><span>Solutions</span></a></li></ul></li><li><a class="tocitem" href="../reference/">Reference</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>World age issue</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>World age issue</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/JuliaIO/FileIO.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/JuliaIO/FileIO.jl/blob/master/docs/src/world_age_issue.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="World-age-issue"><a class="docs-heading-anchor" href="#World-age-issue">World age issue</a><a id="World-age-issue-1"></a><a class="docs-heading-anchor-permalink" href="#World-age-issue" title="Permalink"></a></h1><h2 id="Motivation:-lazy-loading"><a class="docs-heading-anchor" href="#Motivation:-lazy-loading">Motivation: lazy loading</a><a id="Motivation:-lazy-loading-1"></a><a class="docs-heading-anchor-permalink" href="#Motivation:-lazy-loading" title="Permalink"></a></h2><p>The goal of FileIO is to provide a unified IO frontend so that users can easily deal with file IO with the simple <code>load</code>/<code>save</code> functions. The actual IO work will be dispatched to various IO backends. For instance, <a href="https://github.com/JuliaIO/PNGFiles.jl">PNGFiles.jl</a> is used to load PNG format images. If <code>using FileIO</code> were to load all registered IO backends, then it would be very slow to load, hurting all users of FileIO. For any given user, most of those backends would also be unnecessary – for example, people who don&#39;t do image processing probably don&#39;t want to load any thing related to image IO.</p><p>To avoid such unnecessary loading latency, FileIO defers package loading until it&#39;s actually used. For instance, when you use FileIO, you&#39;ll probably observe something like this:</p><pre><code class="language-julia hljs">julia&gt; using TestImages, FileIO

julia&gt; path = testimage(&quot;cameraman&quot;; download_only=true)
&quot;/home/jc/.julia/artifacts/27a4c26bcdd47eb717bee089ec231a899cb8ef69/cameraman.tif&quot;

julia&gt; load(path) # actual backend loading happens here
[ Info: Precompiling ImageIO [82e4d734-157c-48bb-816b-45c225c6df19]
[ Info: Precompiling TiffImages [731e570b-9d59-4bfa-96dc-6df516fadf69]
...</code></pre><p>ImageIO and TiffImages were loaded because the file in <code>path</code> was detected to be a TIFF image, well after FileIO was loaded into the session.</p><h2 id="The-hidden-issue"><a class="docs-heading-anchor" href="#The-hidden-issue">The hidden issue</a><a id="The-hidden-issue-1"></a><a class="docs-heading-anchor-permalink" href="#The-hidden-issue" title="Permalink"></a></h2><p>Although this lazy-loading trick reduces the time needed for <code>using FileIO</code>, it isn&#39;t normal practice in Julia because it introduces a so-called <em>world age issue</em> or <em>world age problem</em>. The world age issue happens when you call methods that get compiled in a newer &quot;world&quot; (get compiled after initial compilation finishes) than the one you called them from.</p><p>Let&#39;s demonstrate the problem concretely. In case you don&#39;t have a suitable file to play with, let&#39;s first create one:</p><pre><code class="language-julia hljs">julia&gt; using IndirectArrays, ImageCore

julia&gt; img = IndirectArray(rand(1:5, 4, 4), rand(RGB, 5))
4×4 IndirectArray{RGB{Float64}, 2, Int64, Matrix{Int64}, Vector{RGB{Float64}}}:
...

julia&gt; save(&quot;indexed_image.png&quot;, img)</code></pre><p>Now, <strong>reopen a new julia REPL</strong> (this is crucial for demonstrating the problem) and call <code>load</code> from <strong>within a function</strong> (this is also crucial):</p><pre><code class="language-julia hljs">julia&gt; using FileIO

julia&gt; f() = size(load(&quot;indexed_image.png&quot;))
f (generic function with 1 method)

julia&gt; f()
ERROR: MethodError: no method matching size(::IndirectArrays.IndirectArray{ColorTypes.RGB{FixedPointNumbers.N0f8}, 2, UInt8, Matrix{UInt8}, OffsetArrays.OffsetVector{ColorTypes.RGB{FixedPointNumbers.N0f8}, Vector{ColorTypes.RGB{FixedPointNumbers.N0f8}}}})
The applicable method may be too new: running in world age 32382, while current world is 32416.
Closest candidates are:
  size(::IndirectArrays.IndirectArray) at ~/.julia/packages/IndirectArrays/BUQO3/src/IndirectArrays.jl:52 (method too new to be called from this world context.)
  size(::AbstractArray{T, N}, ::Any) where {T, N} at abstractarray.jl:42
  size(::Union{LinearAlgebra.Adjoint{T, var&quot;#s880&quot;}, LinearAlgebra.Transpose{T, var&quot;#s880&quot;}} where {T, var&quot;#s880&quot;&lt;:(AbstractVector)}) at /Applications/Julia-1.8.app/Contents/Resources/julia/share/julia/stdlib/v1.8/LinearAlgebra/src/adjtrans.jl:173
  ...
Stacktrace:
 [1] f()
   @ Main ./REPL[2]:1
 [2] top-level scope
   @ REPL[3]:1</code></pre><p>To understand why this happened, you have to understand the order of events:</p><ol><li>When calling <code>f()</code> from the REPL, Julia first compiled <code>f</code>. Importantly, when compiling, Julia didn&#39;t know what type of object was going to be returned by <code>load</code>, so in the compiled code it waits to see what object actually gets returned before figuring out which method of <code>size</code> to call. (This is called <em>runtime dispatch</em>.)</li><li>It queried the file, recognized a PNG file, and <em>loaded the ImageIO and PNGFiles packages</em>. (It&#39;s for the loading of these packages that you needed to start a fresh Julia session.)</li><li>FileIO calls the appropriate PNG-specific <code>load</code> function in PNGFiles. (We&#39;ll have more to say about this step further below.) This causes an image to be returned, which is an array of a type defined by the IndirectArrays package (a dependency of PNGFiles).</li><li><code>f</code> calls <code>size</code> on the returned image. However, this fails, because at the time you called <code>f</code>, the IndirectArrays package wasn&#39;t loaded.</li></ol><p>In other words, <code>size</code> method for <code>IndirectArray</code> lives in a world that&#39;s newer than the one from which you called <code>f()</code>. This leads to the observed error.</p><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>World age is crucial to Julia&#39;s ability to allow you to <em>redefine</em> methods interactively, but the error we&#39;re illustrating is an unfortunate side-effect.</p></div></div><p>The good news is it&#39;s easy to fix, just try calling <code>f()</code> again:</p><pre><code class="language-julia hljs">julia&gt; f()
(4, 4)</code></pre><p>The second <code>f()</code> works because this time you&#39;re calling <code>f()</code> in the latest world age with the necessary <code>size(::IndirectArray)</code> already defined. In essence, you fast-forward to the latest world with each statement you type at the REPL.</p><h2 id="Solutions"><a class="docs-heading-anchor" href="#Solutions">Solutions</a><a id="Solutions-1"></a><a class="docs-heading-anchor-permalink" href="#Solutions" title="Permalink"></a></h2><h3 id="Base.invokelatest"><a class="docs-heading-anchor" href="#Base.invokelatest"><code>Base.invokelatest</code></a><a id="Base.invokelatest-1"></a><a class="docs-heading-anchor-permalink" href="#Base.invokelatest" title="Permalink"></a></h3><p>One solution is to make the call to <code>size</code> via <code>Base.invokelatest</code>, which exists explicitly to work around this world-age dispatch problem. Literally, <code>invokelatest</code> dispatches the supplied call using the latest world age (which may be newer than when you typed <code>f()</code> at the REPL). <strong>In a fresh Julia session</strong>,</p><pre><code class="language-julia hljs">julia&gt; using FileIO

julia&gt; f() = Base.invokelatest(size, load(&quot;indexed_image.png&quot;))
f (generic function with 1 method)

julia&gt; f()
(4, 4)</code></pre><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>In step 3 above (&quot;FileIO calls the appropriate PNG-specific <code>load</code> function in PNGFiles&quot;), the call to the <code>load</code> function defined in PNGFiles is made via <code>invokelatest</code>. Otherwise, even ordinary interactive usage of FileIO (without burying <code>load</code> inside a function) would cause world-age errors.</p></div></div><div class="admonition is-warning"><header class="admonition-header">Warning</header><div class="admonition-body"><p>Using <code>invokelatest</code> slows your code considerably. Use it only when absolutely necessary.</p></div></div><h3 id="Eagerly-load-the-required-packages-first"><a class="docs-heading-anchor" href="#Eagerly-load-the-required-packages-first">Eagerly load the required packages first</a><a id="Eagerly-load-the-required-packages-first-1"></a><a class="docs-heading-anchor-permalink" href="#Eagerly-load-the-required-packages-first" title="Permalink"></a></h3><p>Another solution to the world age issue is simple and doesn&#39;t have long-term downsides: <strong>eagerly load the needed packages</strong>. For instance, if you&#39;re seeing world age issue complaining methods related to <code>IndirectArray</code>, then load IndirectArrays eagerly:</p><pre><code class="language-julia hljs">julia&gt; using FileIO, IndirectArrays # try this on a new Julia REPL

julia&gt; f() = size(load(&quot;indexed_image.png&quot;))
f (generic function with 1 method)

julia&gt; f()
(4, 4)</code></pre><p>Thus if you want to build a package, it could be something like this:</p><pre><code class="language-julia hljs">module MyFancyPackage

# This ensures that whoever loads `MyFancyPackage`, he has IndirectArrays loaded and
# thus avoid the world age issue.
using IndirectArrays, FileIO

f(file) = length(load(file))
end</code></pre><p>Enjoy the FileIO and its lazy loading, but be aware that its speedy loading comes with some caveats.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../implementing/">« Implementing loaders/savers</a><a class="docs-footer-nextpage" href="../reference/">Reference »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.5.0 on <span class="colophon-date" title="Thursday 18 July 2024 17:08">Thursday 18 July 2024</span>. Using Julia version 1.10.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
